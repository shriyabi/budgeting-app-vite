const DATA_START_ROW = 6; 

function doGet(e) {
  try {
    const spreadsheetId = e.parameter.spreadsheetId;
    const sheetName = e.parameter.sheetName; 
    const isMeta = e.parameter.meta === 'true'; 

    if (!spreadsheetId) return jsonResponse({ status: "error", message: "Missing ID" });

    const ss = SpreadsheetApp.openById(spreadsheetId);
    
    if (isMeta) return jsonResponse({ status: "success", allSheets: ss.getSheets().map(function(s) { return s.getName(); }) });

    const targetName = sheetName || "Sheet1";
    let sheet = ss.getSheetByName(targetName);

    if (!sheet) {
      return jsonResponse({ status: "empty", message: "New Budget" });
    }

    const lastRow = sheet.getLastRow();
    
    // read config first 5 rows
    let savedData = {};
    const configCell = sheet.getRange("C1").getValue();
    if (configCell && typeof configCell === 'string' && configCell.startsWith("{")) {
      try { savedData = JSON.parse(configCell); } catch (err) {}
    } 

    let items = [];
    
    // read cat data
    if (lastRow >= DATA_START_ROW) {
      const numRows = lastRow - DATA_START_ROW + 1;
      
      const dataRange = sheet.getRange(DATA_START_ROW, 1, numRows, 5).getValues(); 
      const colorRange = sheet.getRange(DATA_START_ROW, 1, numRows, 1).getBackgrounds(); 

      for (let i = 0; i < dataRange.length; i++) {
        const row = dataRange[i];
        
        if (row[0] && row[0] !== "" && row[0] !== "Category") { 
          
          const isRowActive = row[4] === false ? false : true;

          items.push({
            category: row[0],
            amount: Number(row[1]) || 0,
            recurrenceFreq: row[2] || "",
            lastPaidDate: formatDate(row[3]),
            isActive: isRowActive,
            color: colorRange[i][0] !== '#ffffff' ? colorRange[i][0] : null 
          });
        }
      }
    }
    
    return jsonResponse({ status: "success", savedData, items });

  } catch (err) {
    return jsonResponse({ status: "error", message: err.toString() });
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(data.spreadsheetId);
    let sheet = ss.getSheetByName(data.sheetName);
    
    if (!sheet) sheet = ss.insertSheet(data.sheetName);

    const lastRow = sheet.getLastRow();

    // write config data
    if (data.incomeData) {
       const totalComp = (Number(data.incomeData.salary) || 0) + (Number(data.incomeData.bonus) || 0);
       const headerBlock = [
         ["Budget Period", data.budgetPeriod || "Monthly"], 
         ["Pay Frequency", data.incomeData.payFrequency],   
         ["Net Income", data.netMonthlyIncome || 0],        
         ["Annual Total", totalComp]                      
       ];
       
       sheet.getRange("A1:B4").setValues(headerBlock);
       sheet.getRange("A1:A4").setFontWeight("bold").setBackground("#f3f4f6");
       sheet.getRange("B3").setFontWeight("bold").setFontColor("#047857").setNumberFormat("$#,##0"); 
       sheet.getRange("B4").setNumberFormat("$#,##0"); 
    }

    if (data.incomeData) {
      sheet.getRange("C1").setValue(JSON.stringify(data.incomeData)).setFontColor("#ffffff");
    }

    // clear old data
    if (lastRow >= DATA_START_ROW) {
      sheet.getRange(DATA_START_ROW, 1, lastRow - DATA_START_ROW + 1, 5).clearContent().setBackground(null).clearDataValidations();     
    }

    // write new data
    if (data.items && data.items.length > 0) {
      const rows = data.items.map(item => [
        item.category, 
        item.amount, 
        item.recurrenceFreq || "", 
        item.lastPaidDate || "",
        item.isActive === false ? false : true // Explicitly write FALSE to uncheck the box
      ]);
      
      const numRows = rows.length;
      
   
      sheet.getRange(DATA_START_ROW, 1, numRows, 5).setValues(rows);
      sheet.getRange(DATA_START_ROW, 2, numRows, 1).setNumberFormat("$#,##0");

      // write recurring
      const checkboxRule = SpreadsheetApp.newDataValidation().requireCheckbox().build();
      sheet.getRange(DATA_START_ROW, 5, numRows, 1).setDataValidation(checkboxRule);

      // write colors
      if (data.syncDesign === true) {
        const colorMatrix = data.items.map(item => [item.color && item.color.startsWith('#') ? item.color : "#ffffff"]);
        sheet.getRange(DATA_START_ROW, 1, numRows, 1).setBackgrounds(colorMatrix);
      }
    }

    sheet.getRange("A5:E5")
      .setValues([["Category", "Budgeted", "Frequency", "Last Paid", "Active?"]])
      .setFontWeight("bold")
      .setBackground("#e5e7eb")
      .setBorder(true, false, true, false, false, false);

    sheet.autoResizeColumns(1, 5);

    return jsonResponse({ status: "success", allSheets: ss.getSheets().map(function(s) { return s.getName(); }) });

  } catch (err) {
    return jsonResponse({ status: "error", message: err.toString() });
  }
}

function jsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

function formatDate(dateObj) {
  if (!dateObj) return "";
  try {
    const d = new Date(dateObj);
    return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd");
  } catch (e) { return ""; }
}